PROCEDURE "CHECK_UNIQUE_DATA"
(
  IN  I_BATCH_ID NVARCHAR(36)
)
LANGUAGE SQLSCRIPT
SQL SECURITY INVOKER
AS
BEGIN

  DECLARE duplicate_count INTEGER;
  DECLARE error_message NVARCHAR(5000);

  -- Count duplicate values for UNIQUE columns in this batch
  SELECT COUNT(*) 
    INTO duplicate_count
  FROM (
    SELECT COLUMN_NAME, VALUE
    FROM COM_SCB_UPLOAD_STAGING
    WHERE BATCH_ID = :I_BATCH_ID
    GROUP BY COLUMN_NAME, VALUE
    HAVING COUNT(*) > 1
  );

  -- If duplicates exist, build error message and stop
  IF :duplicate_count > 0 THEN

    SELECT STRING_AGG(
      'Duplicate value "' || VALUE || '" found for UNIQUE column "' || COLUMN_NAME || '"',
      CHAR(10)
    )
    INTO error_message
    FROM (
      SELECT COLUMN_NAME, VALUE
      FROM COM_SCB_UPLOAD_STAGING
      WHERE BATCH_ID = :I_BATCH_ID
      GROUP BY COLUMN_NAME, VALUE
      HAVING COUNT(*) > 1
    );

    SIGNAL SQL_ERROR_CODE 10001
      SET MESSAGE_TEXT = :error_message;

  END IF;

END;
