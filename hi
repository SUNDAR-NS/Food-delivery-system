sap.ui.define([
  "sap/ui/core/mvc/Controller",
  "sap/m/MessageToast",
  "sap/m/MessageBox",
  "sap/ui/core/Fragment",
  "sap/ui/model/json/JSONModel"
], (BaseController) => {
  "use strict";

  return BaseController.extend("fileuploader.controller.templateuploader", {
    onInit: function () {
      // Initialize JSON model for columns
      console.log("wncjiewncjnwjcnwdjcnwecnewncewncencjencjencojwencjowencjowencej")
      this.oModel = this.getOwnerComponent().getModel(); // OData V4 model
      var oColumnsModel = new sap.ui.model.json.JSONModel({
        columns: [
          { COLUMN_NAME: "", DATATYPE: "VARCHAR", LENGTH_PRECISION: "1", SCALE: "0", CONSTRAINTS: "NULL" } // Start with 1 empty row
        ]
      });
      this.getView().setModel(oColumnsModel, "columnsModel");

      const oFunction = this.oModel.bindContext("/getTabVisibility(...)");
      oFunction.execute().then(() => {
        const oCtx = oFunction.getBoundContext();
        const data = oCtx.getObject();
        //enable tabs
        this.byId("templateMakerTab").setVisible(data.template_maker);
        this.byId("templateCheckerTab").setVisible(data.template_maker);
        this.byId("templateEdit").setVisible(data.template_maker);
        if (!data.template_maker) {
          this.byId("templateCheckerTab").setVisible(data.template_checker);
        }

        if (data.template_checker) {
          this.byId("templateApprove").setVisible(data.template_checker);
          this.byId("templateReject").setVisible(data.template_checker);
        }

      });

      this._applyTableFilterChecker();
    },

    _applyTableFilterChecker: function () {
      var oTable = this.byId("templateDashTable").setModel(this.oModel);
      var oBinding = oTable.getBinding("rows");

      const oFunction = this.oModel.bindContext("/TemplateFileStorageChecker(...)");
      oFunction.execute().then(() => {
        const oCtx = oFunction.getBoundContext();
        const data = oCtx.getObject();

        console.log(data.value);
        console.log("==============================================")

        // Filter 1: username in array
        var modules = data.value;

        var aModuleFilters = modules.map(u => new sap.ui.model.Filter("MODULE_NAME", sap.ui.model.FilterOperator.EQ, u));
        // Combine username filters with OR
        var oModuleFilter = new sap.ui.model.Filter({
          filters: aModuleFilters,
          and: false  // OR
        });


        var oSorter = new sap.ui.model.Sorter("createdAt", true); // true = descending
        oBinding.sort([oSorter]);
        oBinding.filter([oModuleFilter]);
      });

    },

    onAddColumn: function () {
      var oModel = this.getView().getModel("columnsModel");
      var aColumns = oModel.getProperty("/columns");
      aColumns.push({
        COLUMN_NAME: "",
        DATATYPE: "NVARCHAR",
        CONSTRAINTS: "NULL"
      });
      oModel.setProperty("/columns", aColumns);
    },

    downloadTemplate: function (oEvent) {
      const oModel = this.getOwnerComponent().getModel();

      const oFunction = oModel.bindContext("/genericTemplate(...)");

      oFunction.execute().then(() => {
        const oCtx = oFunction.getBoundContext();
        const data = oCtx.getObject();

        const byteCharacters = atob(data.FILE_CONTENT);
        const byteNumbers = Array.from(byteCharacters, char => char.charCodeAt(0));
        const byteArray = new Uint8Array(byteNumbers);

        const blob = new Blob([byteArray], { type: data.FILE_MIME_TYPE });


        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = data.FILE_NAME;
        link.click();
      });
    },

    onDeleteRow: function (oEvent) {
      var oTable = this.byId("columnsTable");
      var oItem = oEvent.getSource().getParent(); // ColumnListItem
      var oModel = this.getView().getModel("columnsModel");
      var aData = oModel.getProperty("/columns");

      var iIndex = oTable.indexOfItem(oItem);
      if (iIndex !== -1) {
        aData.splice(iIndex, 1); // remove from array
        oModel.setProperty("/columns", aData); // update model
      }
    },

    onDateChange: function (oEvent) {
      const oDatePicker = oEvent.getSource();
      const sValue = oDatePicker.getValue();

      if (sValue) {
        setTimeout(function () {

          oDatePicker.$().find("input").prop("readonly", true);

        }, 0);


        oDatePicker.$().find(".sapMInputBaseIcon").off("click").on("click", function () {

          oDatePicker.openPicker();
        });
      }

    },

    onNextStepPress: async function () {
      // IDs of your input fields in Step 1
      var bFilled = true;
      var oView = this.getView();
      var oCombo = oView.byId("moduleComboBox1");

      if (!oCombo.getSelectedKey()) {
        oCombo.setValueState("Error");
        oCombo.setValueStateText("Invalid entry");
        sap.m.MessageToast.show("Please fill all required inputs!");
        bFilled = false;
        return;
      } else {
        oCombo.setValueState("None");
      }

      var osubText = oView.byId("submoduleInput");
      if (!osubText.getValue()) {
        osubText.setValueState("Error");
        osubText.setValueStateText("Invalid entry");
        sap.m.MessageToast.show("Please fill all required inputs!");
        bFilled = false;
        return;
      }

      var oTemplateText = oView.byId("templateNameInput");
      if (!oTemplateText.getValue()) {
        oTemplateText.setValueState("Error");
        oTemplateText.setValueStateText("Invalid entry");
        sap.m.MessageToast.show("Please fill all required inputs!");
        bFilled = false;
        return;
      }

      var oDate = this.getView().byId("datePickerId");
      var sValue = oDate.getValue();        // user input as string
      var oDateValue = oDate.getDateValue(); // parsed Date object if valid

      // Case 1: No value entered
      if (!sValue) {
        oDate.setValueState("Error");
        oDate.setValueStateText("Please select a date");
        bFilled = false;
        return;
      }

      // Case 2: Invalid format or non-parsable date
      if (sValue && !oDateValue) {
        oDate.setValueState("Error");
        oDate.setValueStateText("Invalid date format");
        bFilled = false;
        return;
      }

      //write code for validation step-1

      //---START---

      var oSubModule = this.byId("submoduleInput");
      var oTemplate = this.byId("templateNameInput");

      var sSubmoduleValue = oSubModule.getValue();
      var sTemplateValue = oTemplate.getValue();

      var regex = /^[A-Z_]+$/;

      sSubmoduleValue = sSubmoduleValue.toUpperCase();
      sTemplateValue = sTemplateValue.toUpperCase();

      oSubModule.setValue(sSubmoduleValue);
      oTemplate.setValue(sTemplateValue);

      //Validate Submodule Name
      if (!sSubmoduleValue) {
        oSubModule.setValueState("Error");
        oSubModule.setValueStateText("Please enter Submodule Name");
        bFilled = false;
        return;
      }
      else if (!regex.test(sSubmoduleValue)) {
        oSubModule.setValueState("Error");
        oSubModule.setValueStateText("Only alphabets and '_' are allowed");
        bFilled = false;
        return;
      }
      else {
        oSubModule.setValueState("None");
      }

      //Validate Template Name
      if (!sTemplateValue) {
        oTemplate.setValueState("Error");
        oTemplate.setValueStateText("Please enter Submodule Name");
        bFilled = false;
        return;
      }
      else if (!regex.test(sTemplateValue)) {
        oTemplate.setValueState("Error");
        oTemplate.setValueStateText("Only aplhabets and '_' are allowed");
        bFilled = false;
        return;
      }
      else {
        oTemplate.setValueState("None");
      }

      var aFieldIds = ["moduleComboBox1", "submoduleInput", "templateNameInput", "datePickerId"];

      const moduleName = this.byId("moduleComboBox1").getSelectedKey();

      const submoduleName = this.byId("submoduleInput").getValue();

      const templateName = this.byId("templateNameInput").getValue();

      const oWizard = this.byId("templateWizard");

      const oFunction = this.oModel.bindContext("/checkDuplicates(...)");
      oFunction.setParameter("MODULE_NAME", moduleName);
      oFunction.setParameter("SUB_MODULE_NAME", submoduleName);
      oFunction.setParameter("LOAD_TEMPLATE", templateName);
      oFunction.execute().then(() => {
        const oCtx = oFunction.getBoundContext();
        const data = oCtx.getObject();

        if (data.value === true) {
          sap.m.MessageBox.error(`Template name "${templateName}" already exists for this module and submodule`);
          return;
        }
        else {
          oWizard.nextStep();
          aFieldIds.forEach(function (sId) {
            var oControl = this.byId(sId);
            if (oControl && oControl.setEditable) {
              oControl.setEditable(false); // read-only
            }
          }.bind(this));
          this.byId("_IDGenButton").setVisible(false);
        }
      });

    },

    onNextSummary: function () {

  var oModel = this.getView().getModel("columnsModel");
  let aData = oModel.getProperty("/columns");

  for (let row of aData) {
    if (!row.COLUMN_NAME || !row.DATATYPE || !row.CONSTRAINTS) {
      sap.m.MessageToast.show("Please fill all required inputs.");
      return;
    }
  }

  if (this._bPKToggleOn) {
    var bAnyPKSelected = false;
    var oTable = this.byId("columnsTable");
    var aItems = oTable.getItems();

    aItems.forEach(function (oItem) {
      var oCheckBox = oItem.getCells()[0];
      if (oCheckBox.getVisible() && oCheckBox.getSelected()) {
        bAnyPKSelected = true;
      }
    });

    if (!bAnyPKSelected) {
      sap.m.MessageToast.show("Please select at least one Unique column.");
      return;
    }
  }

  this._freezeTable();
  this.byId("_IDGenButtons").setVisible(false);
  this.byId("templateWizard").nextStep();
},

_freezeTable: function () {

  let aItems = this.byId("columnsTable").getItems();
  var aColumns = this.getView().getModel("columnsModel").getData();

  aItems.forEach(item => {
    item.getCells()[0].setEditable(false);
    item.getCells()[1].setEnabled(false);
    item.getCells()[2].setEnabled(false);
    item.getCells()[3].setEnabled(false);
    item.getCells()[4].setEnabled(false);
    item.getCells()[5].setEnabled(false);
  });

  this.byId("columnsTable").setMode("None");
  this.byId("columnsTable").rerender();

  this.byId("_IDGenButton5").setEnabled(false);
  this.byId("_IDGenButton54").setEnabled(false);
  this.byId("_IDGenButton59").setEnabled(false);

  var aTableItems = this.byId("columnsTable").getItems();

  const oSummaryTable = new sap.m.Table({
    inset: false,
    columns: [
      new sap.m.Column({ header: new sap.m.Label({ text: "Column Name" }) }),
      new sap.m.Column({ header: new sap.m.Label({ text: "Data Type" }) }),
      new sap.m.Column({ header: new sap.m.Label({ text: "Constraint" }) }),
      new sap.m.Column({ header: new sap.m.Label({ text: "Unique" }) })
    ],

    items: aColumns.columns.map((col, index) => {

      var bIsUnique = false;
      var oRowItem = aTableItems[index];
      if (oRowItem) {
        var oCheckBox = oRowItem.getCells()[0];
        if (oCheckBox && oCheckBox.getVisible()) {
          bIsUnique = oCheckBox.getSelected();
        }
      }

      let displayType = col.DATATYPE;

      if (col.DATATYPE === "NVARCHAR") {
        col.LENGTH_PRECISION = col.LENGTH_PRECISION ?? 1;
        if (col.LENGTH_PRECISION >= 10000) col.LENGTH_PRECISION = 10000;
        displayType += `(${col.LENGTH_PRECISION})`;
      } else if (col.DATATYPE === "DECIMAL") {
        col.LENGTH_PRECISION = col.LENGTH_PRECISION ?? 1;
        col.SCALE = col.SCALE ?? 0;
        if (col.LENGTH_PRECISION >= 1000) col.LENGTH_PRECISION = 1000;
        if (col.SCALE >= 38) col.SCALE = 38;
        displayType += `(${col.LENGTH_PRECISION},${col.SCALE})`;
      }

      return new sap.m.ColumnListItem({
        cells: [
          new sap.m.Text({ text: col.COLUMN_NAME }),
          new sap.m.Text({ text: displayType }),
          new sap.m.Text({ text: col.CONSTRAINTS }),
          new sap.ui.core.Icon({
            src: bIsUnique ? "sap-icon://accept" : "sap-icon://decline",
            tooltip: bIsUnique ? "Unique" : "Not Unique"
          })
        ]
      });
    })
  });

  const oSubmitButton = new sap.m.Button({
    text: "Submit",
    type: "Ghost",
    press: this.openTempateDashboard.bind(this, oSummaryTable)
  });

  const oLayout = new sap.m.VBox({
    items: [oSummaryTable, oSubmitButton],
    width: "100%"
  });

  const oStep3 = this.byId("step3");
  oStep3.removeAllContent();
  oStep3.addContent(oLayout);
},

openTempateDashboard: async function (oTable) {

  var aItems = oTable.getItems();
  var aData = [];

  aItems.forEach(function (oItem) {
    var aCells = oItem.getCells();

    // ✅ FIX: read ICON instead of text
    var bIsUnique = false;
    if (aCells[3] && aCells[3].getSrc) {
      bIsUnique = aCells[3].getSrc() === "sap-icon://accept";
    }

    aData.push({
      COLUMN_NAME: aCells[0].getText(),
      DATA_TYPE: aCells[1].getText(),
      CONSTRAINTS: aCells[2].getText(),
      IS_UNIQUE: bIsUnique
    });
  });

  const payload = {
    MODULE_NAME: this.byId("moduleComboBox1").getSelectedKey(),
    SUB_MODULE_NAME: this.byId("submoduleInput").getValue(),
    LOAD_TEMPLATE: this.byId("templateNameInput").getValue(),
    STATUS: "pending",
    EXPIRY_DATE: this.byId("datePickerId").getValue(),
    JSON_TEMPLATE: JSON.stringify(aData)
  };

  const listBinding = this.oModel.bindList("/TemplateStorage");
  const context = await listBinding.create(payload);
  await context.created();

  location.reload();
},

    onDataTypeChange: function (oEvent) {
      const oSelectedItem = oEvent.getSource().getSelectedKey();
      const oContext = oEvent.getSource().getBindingContext("columnsModel");
      const oRowData = oContext.getObject();

      // Reset values based on type
      if (oSelectedItem !== "DECIMAL") {
        oRowData.scale = null;
      }
      if (oSelectedItem !== "NVARCHAR" && oSelectedItem !== "DECIMAL") {
        oRowData.length = null;
      }

      // Refresh model to reflect changes
      this.getView().getModel("columnsModel").refresh();
    },

    onOpenFileDialog: function () {
      var oView = this.getView();

      // create dialog if not exists
      if (!this._pDialog) {
        this._pDialog = sap.ui.core.Fragment.load({
          id: oView.getId(),
          name: "fileuploader.view.fragment.FileUploaderDialog", // fragment path
          controller: this
        }).then(function (oDialog) {
          oView.addDependent(oDialog);
          return oDialog;
        });
      }
      this._pDialog.then(function (oDialog) {
        oDialog.open();
      });
    },

    onCloseDialog: function () {
      this.byId("fileUploadDialog").close();
    },

   onUpload: function () {
      var oFileUploader = this.byId("genericFileuploader");

      console.log(oFileUploader);
      const file = oFileUploader.getDomRef("fu").files?.[0];

      const maxSize = 3 * 1024 * 1024;
      if (file.size > maxSize) {
        sap.m.MessageBox.alert("File size exceeds 3 MB. Please upload a smaller file`.");
        return; // stop further execution
      }
      // sap.ui.core.BusyIndicator.show(0);
      this.oColumnsModel = new sap.ui.model.json.JSONModel({ columns: [] });
      this.getView().setModel(this.oColumnsModel, "columnsModel");
      const reader = new FileReader();
      reader.onload = async () => {
        const base64Content = reader.result.split(",")[1];

        const oFunction = this.oModel.bindContext("/extractGenericTemplate(...)");
        oFunction.setParameter("FILE_CONTENT", base64Content);
        oFunction.execute().then(() => {

          const oCtx = oFunction.getBoundContext();
          const data = oCtx.getObject();

          var jsonObjects = data.JSON_DATA.map(item => JSON.parse(item));

          const finObj = { columns: jsonObjects }
          this.oColumnsModel.setProperty("/", finObj);
          this.onCloseDialog();


        });


      };

      reader.readAsDataURL(file);

    },
    onPreviewPress: function (oEvent) {
      var oSource = oEvent.getSource();
      var sId = oSource.getCustomData()[0].getValue();
      var oModel = this.getOwnerComponent().getModel();
      this.onPreview(sId)
    },

    onPreview: async function (sId) {

      const oView = this.getView();
      const ID = sId;

      const oModel = this.getOwnerComponent().getModel();

      const oFunction = oModel.bindContext("/fetchTemplatePreview(...)");
      oFunction.setParameter("ID", ID);

      await oFunction.execute();
      const oCtx = oFunction.getBoundContext();
      const data = oCtx.getObject(); // full JSON array
      const first10 = data.value;

      const oFirstRecord = first10[0];

      const oModels = new sap.ui.model.json.JSONModel({ rows: first10 });
      oView.setModel(oModels, "preview");

      const aColumns = [];
      // Create table
      const oTable = new sap.ui.table.Table({
        visibleRowCount: 12,     // Vertical scroll when more than 10 rows
        selectionMode: "None",
        columnHeaderVisible: true,
        rows: { path: "preview>/rows" }
      });

      for (const key in oFirstRecord) {
        oTable.addColumn(new sap.ui.table.Column({
          label: new sap.m.Label({ text: key }),
          template: new sap.m.Text({ text: `{preview>${key}}` }),
          sortProperty: key,
          filterProperty: key
        }));
      }

      if (!this._oPreviewDialog) {
        this._oPreviewDialog = await sap.ui.core.Fragment.load({
          id: oView.getId(),
          name: "fileuploader.view.fragment.PreviewDialog",
          controller: this
        });
        oView.addDependent(this._oPreviewDialog);

      }

      const oHeader = new sap.m.Bar({
        contentMiddle: [
          new sap.m.Title({ text: "Preview" }) // Dialog title
        ],
        contentRight: [
          new sap.m.Button({
            text: data.value.length,
            type: "Transparent",
            icon: "sap-icon://table-view",
            tooltip: data.value.length + ' Rows'
          })
        ]
      });

      this._oPreviewDialog.setCustomHeader(oHeader);


      this._oPreviewDialog.removeAllContent();
      this._oPreviewDialog.addContent(oTable);

      this._oPreviewDialog.open();
    },

    onClosePreview: function () {
      this._oPreviewDialog.close();
    },

    onEditPress: async function () {
      const oTable = this.byId("templateDashTable");
      const aSelectedIndices = oTable.getSelectedIndices();
      if (aSelectedIndices.length !== 1) {
        sap.m.MessageToast.show("Please select only one row");
        return;
      }
      const oRowData = oTable.getContextByIndex(aSelectedIndices[0]).getObject();
      if (!this._oEditExpiryDialog) {
        this._oEditExpiryDialog = await sap.ui.core.Fragment.load({ id: this.getView().getId(), name: "fileuploader.view.fragment.EditExpiry", controller: this });
        this.getView().addDependent(this._oEditExpiryDialog);
      }
      const oDatePicker = this.byId("editExpiryDatePicker");
      oDatePicker.setValue(oRowData.EXPIRY_DATE || "");
      this._oEditExpiryDialog.open();
    },


    onEditExpiryCancel: function () {
      if (this._oEditExpiryDialog) {
        this._oEditExpiryDialog.close();
      }
    },


    onPrimaryKeyToggle: function (oEvent) {
      const isOn = oEvent.getParameter("pressed");
      this._bPKToggleOn = isOn;

      var aItems = this.byId("columnsTable").getItems();
      aItems.forEach(item => {
        var cb = item.getCells()[0];
        cb.setVisible(isOn);
        if (!isOn) cb.setSelected(false);
      });
    },

    //checkbox primary key function - shivani 
    onCheckboxSelect: function (oEvent) {
      // We don’t need to deselect other checkboxes
      // Multiple selection is allowed
      // Optional: highlight row visually
      var selectedCB = oEvent.getSource();
      var row = selectedCB.getParent();

      if (selectedCB.getSelected()) {
        row.addStyleClass("pkSelectedRow"); // optional visual highlight
      } else {
        row.removeStyleClass("pkSelectedRow");
      }
    },


    onEditExpirySave: async function () {
      const oDialog = this._oEditExpiryDialog;
      const oDatePicker = this.byId("editExpiryDatePicker");
      const sNewDate = oDatePicker.getValue();
      if (!sNewDate) {
        oDatePicker.setValueState("Error");
        oDatePicker.setValueStateText("Please select a date");
        return;
      }
      oDatePicker.setValueState("None");
      const oTable = this.byId("templateDashTable");
      const aIndices = oTable.getSelectedIndices();
      if (aIndices.length !== 1) {
        sap.m.MessageToast.show("Please select exactly 1 row.");
        return;
      }
      const row = oTable.getContextByIndex(aIndices[0]).getObject();
      const oModel = this.getOwnerComponent().getModel();
      const fn = oModel.bindContext("/EditTemplateExpiry(...)");
      fn.setParameter("id", row.ID);
      fn.setParameter("newExpiryDate", sNewDate);

      try {
        await fn.execute();
        const ctx = fn.getBoundContext();
        const result = ctx.getObject();
        //sap.m.MessageToast.show(result.value);
        const oTable = this.byId("templateDashTable");
        oTable.getBinding("rows").refresh();
        oDialog.close();
      } catch (err) {
        console.error(err);
        sap.m.MessageToast.show("Error updating expiry");
      }
    },


    onActionPress: async function (oEvent) {

      if (this._isBusy) return;
      this._isBusy = true;

      sap.ui.core.BusyIndicator.show(0);

      const oButton = oEvent.getSource();

      const actionType = oButton.getCustomData().find(d => d.getKey() === "action").getValue();

      const oTable = this.byId("templateDashTable");
      const aSelectedIndices = oTable.getSelectedIndices();

      if (aSelectedIndices.length !== 1) {
        sap.m.MessageToast.show(`Please select any one row to ${actionType}.`);
        sap.ui.core.BusyIndicator.hide();
        this._isBusy = false;
        return;
      }

      const oRowData = oTable.getContextByIndex(aSelectedIndices[0]).getObject();
      const selectedId = oRowData.ID;

      if (oRowData.STATUS != "pending") {
        sap.m.MessageBox.error("Action already taken (" + oRowData.STATUS + "). You cannot perform this action again.");
        sap.ui.core.BusyIndicator.hide();
        this._isBusy = false;
        return;
      }

      //call backend to approve or reject
      const Model = this.getOwnerComponent().getModel();
      const oFunction = Model.bindContext("/UpdateStatusTemplate(...)");

      oFunction.setParameter("id", selectedId);
      oFunction.setParameter("action", actionType);

      try {
        await oFunction.execute();
        const oCtx = oFunction.getBoundContext();
        const data = oCtx.getObject();

        const oBindings = oTable.getBinding("rows");
        if (oBindings) oBindings.refresh();

        sap.m.MessageBox.information(data.value);
      } catch (err) {
        console.error(err);
        sap.m.MessageToast.show("Error updating action");
      }
      finally {
        sap.ui.core.BusyIndicator.hide();
        this._isBusy = false;
      }

    },

    onColumnNameChange: function (oEvent) {
      var oInput = oEvent.getSource();
      var sValue = oInput.getValue();

      //convert to upper case
      var sUpper = sValue.toUpperCase();

      //remove all wrong characters
      var sCleanValue = sUpper.replace(/[^A-Z0-9_]/g, "");

      if (sValue !== sCleanValue) {
        oInput.setValue(sCleanValue);
      }
      //validate further 
      if (!sCleanValue) {
        oInput.setValueState(sap.ui.core.ValueState.Error);
        oInput.setValueStateText("No Empty or Special Characters allowed");
      } else {
        oInput.setValueState(sap.ui.core.ValueState.None);
      }
    },



  });
});
