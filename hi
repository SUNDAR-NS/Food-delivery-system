onPrimaryKeyToggle: function (oEvent) {
  const isOn = oEvent.getParameter("state"); 
  this._bPKToggleOn = isOn;

  var aItems = this.byId("columnsTable").getItems();
  aItems.forEach(item => {
    var cb = item.getCells()[0]; 
    cb.setVisible(isOn);
    if (!isOn) {
      cb.setSelected(false); 
      item.removeStyleClass("pkSelectedRow"); 
    }
  });
},


onCheckboxSelect: function (oEvent) {
  var selectedCB = oEvent.getSource();
  var row = selectedCB.getParent();

  if (selectedCB.getSelected()) {
    row.addStyleClass("pkSelectedRow");
  } else {
    row.removeStyleClass("pkSelectedRow");
  }
},


onNextSummary: function () {

  var oModel = this.getView().getModel("columnsModel");
  let aData = oModel.getProperty("/columns");

  for (let row of aData) {
    if (!row.COLUMN_NAME || !row.DATATYPE || !row.CONSTRAINTS) {
      sap.m.MessageToast.show("Please fill all required inputs.");
      return;
    }
  }

  if (this._bPKToggleOn) {
    var bAnyPKSelected = false;
    var oTable = this.byId("columnsTable");
    var aItems = oTable.getItems();

    aItems.forEach(function (oItem) {
      var oCheckBox = oItem.getCells()[0];
      if (oCheckBox.getVisible() && oCheckBox.getSelected()) {
        bAnyPKSelected = true;
      }
    });

    if (!bAnyPKSelected) {
      sap.m.MessageToast.show("Please select at least one Unique column.");
      return;
    }
  }

  this._freezeTable();
  this.byId("_IDGenButtons").setVisible(false);
  this.byId("templateWizard").nextStep();
},

_freezeTable: function () {

  let aItems = this.byId("columnsTable").getItems();
  var aColumns = this.getView().getModel("columnsModel").getData();

  aItems.forEach(item => {
    item.getCells()[0].setEditable(false);
    item.getCells()[1].setEnabled(false);
    item.getCells()[2].setEnabled(false);
    item.getCells()[3].setEnabled(false);
    item.getCells()[4].setEnabled(false);
    item.getCells()[5].setEnabled(false);
  });

  this.byId("columnsTable").setMode("None");
  this.byId("columnsTable").rerender();

  this.byId("_IDGenButton5").setEnabled(false);
  this.byId("_IDGenButton54").setEnabled(false);
  this.byId("_IDGenButton59").setEnabled(false);

  var aTableItems = this.byId("columnsTable").getItems();

  const oSummaryTable = new sap.m.Table({
    inset: false,
    columns: [
      new sap.m.Column({ header: new sap.m.Label({ text: "Column Name" }) }),
      new sap.m.Column({ header: new sap.m.Label({ text: "Data Type" }) }),
      new sap.m.Column({ header: new sap.m.Label({ text: "Constraint" }) }),
      new sap.m.Column({ header: new sap.m.Label({ text: "Unique" }) })
    ],

    items: aColumns.columns.map((col, index) => {

      var bIsUnique = false;
      var oRowItem = aTableItems[index];
      if (oRowItem) {
        var oCheckBox = oRowItem.getCells()[0];
        if (oCheckBox && oCheckBox.getVisible()) {
          bIsUnique = oCheckBox.getSelected();
        }
      }

      let displayType = col.DATATYPE;

      if (col.DATATYPE === "NVARCHAR") {
        col.LENGTH_PRECISION = col.LENGTH_PRECISION ?? 1;
        if (col.LENGTH_PRECISION >= 10000) col.LENGTH_PRECISION = 10000;
        displayType += `(${col.LENGTH_PRECISION})`;
      } else if (col.DATATYPE === "DECIMAL") {
        col.LENGTH_PRECISION = col.LENGTH_PRECISION ?? 1;
        col.SCALE = col.SCALE ?? 0;
        if (col.LENGTH_PRECISION >= 1000) col.LENGTH_PRECISION = 1000;
        if (col.SCALE >= 38) col.SCALE = 38;
        displayType += `(${col.LENGTH_PRECISION},${col.SCALE})`;
      }

      return new sap.m.ColumnListItem({
        cells: [
          new sap.m.Text({ text: col.COLUMN_NAME }),
          new sap.m.Text({ text: displayType }),
          new sap.m.Text({ text: col.CONSTRAINTS }),
          new sap.ui.core.Icon({
            src: bIsUnique ? "sap-icon://accept" : "sap-icon://decline",
            tooltip: bIsUnique ? "Unique" : "Not Unique"
          })
        ]
      });
    })
  });

  const oSubmitButton = new sap.m.Button({
    text: "Submit",
    type: "Ghost",
    press: this.openTempateDashboard.bind(this, oSummaryTable)
  });

  const oLayout = new sap.m.VBox({
    items: [oSummaryTable, oSubmitButton],
    width: "100%"
  });

  const oStep3 = this.byId("step3");
  oStep3.removeAllContent();
  oStep3.addContent(oLayout);
},

openTempateDashboard: async function (oTable) {

  var aItems = oTable.getItems();
  var aData = [];

  aItems.forEach(function (oItem) {
    var aCells = oItem.getCells();

    // âœ… FIX: read ICON instead of text
    var bIsUnique = false;
    if (aCells[3] && aCells[3].getSrc) {
      bIsUnique = aCells[3].getSrc() === "sap-icon://accept";
    }

    aData.push({
      COLUMN_NAME: aCells[0].getText(),
      DATA_TYPE: aCells[1].getText(),
      CONSTRAINTS: aCells[2].getText(),
      IS_UNIQUE: bIsUnique
    });
  });

  const payload = {
    MODULE_NAME: this.byId("moduleComboBox1").getSelectedKey(),
    SUB_MODULE_NAME: this.byId("submoduleInput").getValue(),
    LOAD_TEMPLATE: this.byId("templateNameInput").getValue(),
    STATUS: "pending",
    EXPIRY_DATE: this.byId("datePickerId").getValue(),
    JSON_TEMPLATE: JSON.stringify(aData)
  };

  const listBinding = this.oModel.bindList("/TemplateStorage");
  const context = await listBinding.create(payload);
  await context.created();

  location.reload();
},
